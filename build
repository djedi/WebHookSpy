#!/usr/bin/env bash
set -euo pipefail

DOCKER_USER="xhenxhe"
IMAGE_NAME="webhookspy"
FULL_IMAGE="${DOCKER_USER}/${IMAGE_NAME}"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

usage() {
    echo -e "${BLUE}WebhookSpy Build & Push Script${NC}"
    echo ""
    echo "Usage: ./build [command] [options]"
    echo ""
    echo "Commands:"
    echo "  (none)        Build the image locally (default)"
    echo "  push          Build and push to Docker Hub"
    echo "  release       Build, tag with version, and push"
    echo "  multi         Build multi-platform and push (amd64 + arm64)"
    echo ""
    echo "Options:"
    echo "  -t, --tag     Specify a custom tag (default: latest)"
    echo "  --no-cache    Build without using cache"
    echo "  --dry-run     Show what would be done without executing"
    echo "  -h, --help    Show this help message"
    echo ""
    echo "Examples:"
    echo "  ./build                      # Build locally with 'latest' tag"
    echo "  ./build push                 # Build and push to Docker Hub"
    echo "  ./build push -t v1.0.0       # Build and push with specific tag"
    echo "  ./build release -t v1.0.0    # Tag as v1.0.0 and latest, then push"
    echo "  ./build multi -t v1.0.0      # Multi-platform build and push"
}

log_info() {
    echo -e "${GREEN}[INFO]${NC} $1"
}

log_warn() {
    echo -e "${YELLOW}[WARN]${NC} $1"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

log_step() {
    echo -e "${BLUE}[STEP]${NC} $1"
}

# Parse arguments
COMMAND=""
TAG="latest"
NO_CACHE=""
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help|help)
            usage
            exit 0
            ;;
        -t|--tag)
            TAG="$2"
            shift 2
            ;;
        --no-cache)
            NO_CACHE="--no-cache"
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        push|release|multi)
            COMMAND="$1"
            shift
            ;;
        *)
            if [[ -z "$COMMAND" ]]; then
                COMMAND="$1"
            fi
            shift
            ;;
    esac
done

run_cmd() {
    if $DRY_RUN; then
        echo -e "${YELLOW}[DRY-RUN]${NC} $*"
    else
        "$@"
    fi
}

check_docker_login() {
    if ! docker info 2>/dev/null | grep -q "Username"; then
        log_warn "Not logged into Docker Hub. Attempting login..."
        if ! $DRY_RUN; then
            docker login
        fi
    fi
}

cmd_build() {
    log_step "Building ${FULL_IMAGE}:${TAG}"
    run_cmd docker build $NO_CACHE -t "${FULL_IMAGE}:${TAG}" .
    log_info "Successfully built ${FULL_IMAGE}:${TAG}"
    echo ""
    echo -e "Run locally with:"
    echo -e "  ${BLUE}docker run -p 8147:8147 -v webhookspy-data:/app/data ${FULL_IMAGE}:${TAG}${NC}"
}

cmd_push() {
    check_docker_login

    log_step "Building ${FULL_IMAGE}:${TAG}"
    run_cmd docker build $NO_CACHE -t "${FULL_IMAGE}:${TAG}" .

    log_step "Pushing ${FULL_IMAGE}:${TAG}"
    run_cmd docker push "${FULL_IMAGE}:${TAG}"

    log_info "Successfully pushed ${FULL_IMAGE}:${TAG}"
}

cmd_release() {
    if [[ "$TAG" == "latest" ]]; then
        log_error "Please specify a version tag for release: ./build release -t v1.0.0"
        exit 1
    fi

    check_docker_login

    log_step "Building ${FULL_IMAGE}:${TAG}"
    run_cmd docker build $NO_CACHE -t "${FULL_IMAGE}:${TAG}" .

    log_step "Tagging as latest"
    run_cmd docker tag "${FULL_IMAGE}:${TAG}" "${FULL_IMAGE}:latest"

    log_step "Pushing ${FULL_IMAGE}:${TAG}"
    run_cmd docker push "${FULL_IMAGE}:${TAG}"

    log_step "Pushing ${FULL_IMAGE}:latest"
    run_cmd docker push "${FULL_IMAGE}:latest"

    log_info "Successfully released ${FULL_IMAGE}:${TAG} and updated :latest"
}

cmd_multi() {
    check_docker_login

    # Ensure buildx is available
    if ! docker buildx version &>/dev/null; then
        log_error "Docker buildx is required for multi-platform builds"
        exit 1
    fi

    # Create/use builder
    BUILDER_NAME="webhookspy-builder"
    if ! docker buildx inspect "$BUILDER_NAME" &>/dev/null; then
        log_step "Creating buildx builder: $BUILDER_NAME"
        run_cmd docker buildx create --name "$BUILDER_NAME" --use
    else
        run_cmd docker buildx use "$BUILDER_NAME"
    fi

    log_step "Building multi-platform image for amd64 and arm64"

    local push_tags="-t ${FULL_IMAGE}:${TAG}"
    if [[ "$TAG" != "latest" ]]; then
        push_tags="$push_tags -t ${FULL_IMAGE}:latest"
    fi

    run_cmd docker buildx build \
        --platform linux/amd64,linux/arm64 \
        $NO_CACHE \
        $push_tags \
        --push \
        .

    log_info "Successfully built and pushed multi-platform image"
    echo ""
    echo "Supported platforms:"
    echo "  - linux/amd64 (Intel/AMD)"
    echo "  - linux/arm64 (Apple Silicon, AWS Graviton, Raspberry Pi)"
}

# Execute command
case "${COMMAND:-build}" in
    build|"")
        cmd_build
        ;;
    push)
        cmd_push
        ;;
    release)
        cmd_release
        ;;
    multi)
        cmd_multi
        ;;
    *)
        log_error "Unknown command: $COMMAND"
        echo ""
        usage
        exit 1
        ;;
esac
